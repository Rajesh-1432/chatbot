<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <title>PDF Chatbot</title>
  </head>
  <body>
    <div class="container">
      <h1>PDF Chatbot</h1>

      <h2>Upload PDF</h2>
      <form id="uploadForm" enctype="multipart/form-data">
        <input
          type="file"
          name="file"
          id="fileInput"
          onchange="handleFileChange()"
        />
        <button type="submit">Upload</button>
      </form>

      <hr />
      <div id="chatHistory"></div>

      <hr />

      <h2>Ask Question</h2>
      <div class="message-container">
        <input
          type="text"
          id="questionInput"
          placeholder="Enter your question"
          disabled
          onkeydown="handleKeyDown(event)"
        />
        <button onclick="askQuestion()">Ask</button>
      </div>
    </div>

    <script>
      function handleFileChange() {
        const fileInput = document.getElementById("fileInput");
        const questionInput = document.getElementById("questionInput");
        questionInput.disabled = fileInput.files.length === 0;
      }

      function askQuestion() {
        const questionInput = document.getElementById("questionInput");
        const askButton = document.querySelector(".message-container button");

        // Disable input and change button text to loading animation
        questionInput.disabled = true;
        askButton.innerHTML = '<span class="loader"></span>';

        const question = questionInput.value.trim();
        if (question === "") {
          alert("Please enter a question");
          // Re-enable input and reset button text if no question is entered
          questionInput.disabled = false;
          askButton.innerHTML = "Ask";
          return;
        }

        fetch("http://http://18.234.23.124:5000/ask-question", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ question, chat_history: [] }),
        })
          .then((response) => response.json())
          .then((data) => {
            const response = data.response;
            const chatHistory = data.chat_history;

            // Update chat history
            const chatHistoryDiv = document.getElementById("chatHistory");
            const humanMessageContainer = document.createElement("div");
            humanMessageContainer.classList.add("message-container", "human");
            const humanMessage = document.createElement("div");
            humanMessage.classList.add("message", "human");
            humanMessage.textContent = question;
            humanMessageContainer.appendChild(humanMessage);
            chatHistoryDiv.appendChild(humanMessageContainer);

            const botMessageContainer = document.createElement("div");
            botMessageContainer.classList.add("message-container", "bot");
            const botMessage = document.createElement("div");
            botMessage.classList.add("message", "bot");
            botMessage.textContent = response;
            botMessageContainer.appendChild(botMessage);
            chatHistoryDiv.appendChild(botMessageContainer);

            // Scroll to the bottom
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;

            // Re-enable input and reset button text
            questionInput.disabled = false;
            askButton.innerHTML = "Ask";
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("An error occurred while sending the message");
            // Re-enable input and reset button text
            questionInput.disabled = false;
            askButton.innerHTML = "Ask";
          });
      }
      function handleKeyDown(event) {
        if (event.key === "Enter") {
          askQuestion();
        }
      }

      document
        .getElementById("uploadForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          const formData = new FormData(this);

          fetch("http://localhost:5000/upload-pdf", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              alert(data.message);
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("An error occurred while uploading the PDF");
            });
        });
    </script>
  </body>
</html>
